#!/bin/bash

# Source code provided to directory
S2I_SOURCE_DIR=${S2I_SOURCE_DIR-"/tmp/src"}

# Setup build nev
export JAVA_TOOL_OPTIONS="$JAVA_TOOL_OPTIONS \
-DbaseUrl=$TARGET_URL \
-DbuildVersion=$BUILD_VERSION \
-DinfraVersion=$INFRA_VERSION \
-DcommonVersion=$COMMON_VERSION \
-Dfile.encoding=UTF-8"

# .gradle stuff are in /tmp
export GRADLE_USER_HOME=/tmp/.gradle

if [ $# -gt 1  ] && [ "$1" = "testrun" ]; then
    shift
    TEST=${1}
    RESULT="FAILED"
    echo "---> User $(id) home is $HOME"

    # Test
    GRADLE_ARGS=${GRADLE_ARGS:-"--no-daemon ${*}"}
    echo "---> Testing application with GRADLE_ARGS=$GRADLE_ARGS"
    (cd $S2I_SOURCE_DIR; ./gradlew $GRADLE_ARGS)
    [ $? -eq 0 ] && RESULT="SUCCESS"

    echo "---> Test $RESULT, copy test reports to $REPORT_DIR"
    # Copy test results to persistent volume mount
    mkdir -p $REPORT_DIR && \
        cp -R $S2I_SOURCE_DIR/web/build/reports/tests/$TEST/* $REPORT_DIR/.
    
    # Report back
    echo "---> Done, report back status $RESULT to $CALLBACK_URL"
    curl -X POST -k -d $RESULT $CALLBACK_URL    
else
    $(dirname "$0")/usage
fi
