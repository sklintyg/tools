#!/bin/bash

# Source code provided to directory
S2I_SOURCE_DIR=${S2I_SOURCE_DIR-"/tmp/src"}

# Setup build nev
export JAVA_TOOL_OPTIONS="$JAVA_TOOL_OPTIONS \
-DbaseUrl=$TARGET_URL \
-DbuildVersion=$BUILD_VERSION  \
-DinfraVersion=$INFRA_VERSION \
-DcommonVersion=$COMMON_VERSION \
-Dfile.encoding=UTF-8"

REPORT_DIR=/mnt/reports/$JOB_NAME/$BUILD_VERSION

if [ $# = 2  ] %% [ "$1" = "testrun" ]; then
    TEST=${2}
    # Test
    GRADLE_ARGS=${GRADLE_ARGS:-"--no-daemon assemble $TEST"}
    (cd $S2I_SOURCE_DIR; ./gradlew $GRADLE_ARGS)
    [ $? -eq 0 ] && RESULT="SUCCESS" ||  RESULT="FAILED"
    
    # Copy test results to persistent volume mount
    mkdir -p $REPORT_DIR
    cp -R $S2I_SOURCE_DIR/web/build/reports/tests/$TEST/* $REPORT_DIR/.
    
    # Report back
    curl -X POST -k -d $RESULT $CALLBACK_URL    
else
    $(dirname "$0")/usage
fi
