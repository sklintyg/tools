#!/bin/bash

# Source code provided to directory
S2I_SOURCE_DIR=${S2I_SOURCE_DIR-"/tmp/src"}

# Setup build nev
export JAVA_TOOL_OPTIONS="$JAVA_TOOL_OPTIONS \
-DbaseUrl=$TARGET_URL \
-Dprotractor.env=test-pipeline \
-DbuildVersion=$BUILD_VERSION \
-DinfraVersion=$INFRA_VERSION \
-DcommonVersion=$COMMON_VERSION \
-Dfile.encoding=UTF-8"

# .gradle stuff are in /tmp
export GRADLE_USER_HOME=/tmp/.gradle

function testrun() {
    ARGS="$1"
    [ "$ARGS" = "fitnesseTest" ] && ARGS="$ARGS -PfileOutput -PoutputFormat=html"
    ARGS="$ARGS -x processResources"
    echo "---> Testing application with GRADLE_ARGS=$ARGS"
    (cd $S2I_SOURCE_DIR; ./gradlew $ARGS)
    ERR=$?
    return $ERR
}

if [ $# -gt 1  ] && [ "$1" = "testrun" ]; then
    echo "---> User $(id) home is $HOME"
    echo "---> Report dir is $REPORT_DIR"
    mkdir -p $REPORT_DIR
    RESULT=SUCCESS

    shift
    TESTS=(${*/,/ })
    for TEST in ${TESTS[*]}
    do
        testrun $TEST
        [ $? -ne 0 ] && RESULT=FAILED
        case "$TEST" in
            "restAssuredTest")
                FROM=$S2I_SOURCE_DIR/web/build/reports/tests/$TEST
                echo "---> Save reports $FROM"
                [ -d $FROM ] && cp -R $FROM/* $REPORT_DIR/. && mv $REPORT_DIR/index.html $REPORT_DIR/restassured-results.html 
                ;;
            "protractorTest")
                FROM=$S2I_SOURCE_DIR/test/reports/index.html
                echo "---> Save reports $FROM"
                [ -f $FROM ] && cp $FROM $REPORT_DIR/protractor-results.html
                ;;
            "fitnesseTest")
                FROM=$S2I_SOURCE_DIR/test/fitnesse-results.html
                echo "---> Save reports $FROM"
                [ -f $FROM ] && cp $FROM $REPORT_DIR/
                ;;
        esac
    done

    # Report back
    echo "---> Done, report back status $RESULT to $CALLBACK_URL"
    curl -X POST -k -d $RESULT $CALLBACK_URL
else
    $(dirname "$0")/usage
fi