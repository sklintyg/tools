#!/bin/bash

# Source code provided to directory
S2I_SOURCE_DIR=${S2I_SOURCE_DIR-"/tmp/src"}

# Setup build nev
export JAVA_TOOL_OPTIONS="$JAVA_TOOL_OPTIONS \
-DbaseUrl=$TARGET_URL \
-DbuildVersion=$BUILD_VERSION \
-DinfraVersion=$INFRA_VERSION \
-DcommonVersion=$COMMON_VERSION \
-Dfile.encoding=UTF-8"

REPORT_DIR=/mnt/reports/$JOB_NAME/$BUILD_VERSION

# .gradle stuff are in /tmp
export GRADLE_USER_HOME=/tmp/.gradle

if [ $# = 2  ] && [ "$1" = "testrun" ]; then
    TEST=${2}
    RESULT="FAILED"
    echo "---> User $(id) home is $HOME"

    # Test
    GRADLE_ARGS=${GRADLE_ARGS:-"--no-daemon $TEST -x processResources"}
    echo "---> Testing application with GRADLE_ARGS=$GRADLE_ARGS"
    (cd $S2I_SOURCE_DIR; ./gradlew $GRADLE_ARGS)
    if [ $? -eq 0 ]; then
        echo "---> Test OK, copy test reports to $REPORT_DIR"
        # Copy test results to persistent volume mount
        mkdir -p $REPORT_DIR && \
            cp -R $S2I_SOURCE_DIR/web/build/reports/tests/$TEST/* $REPORT_DIR/. && \
            RESULT="SUCCESS"
    fi
    
    # Report back
    echo "---> Done, report back status $RESULT to $CALLBACK_URL"
    curl -X POST -k -d $RESULT $CALLBACK_URL    
else
    $(dirname "$0")/usage
fi
