#!/bin/sh
. $(dirname $0)/common.sh
# . /opt/rh/rh-maven33/enable

LOCAL_SOURCE_DIR=/tmp/src
mkdir -p $LOCAL_SOURCE_DIR

DEPLOY_DIR=$JWS_HOME/webapps

echo "Local directory: $(pwd)"
echo "dirname: $(dirname $0)"

# the subdirectory within LOCAL_SOURCE_DIR from where we should copy build artifacts

configure_proxy
configure_mirrors

manage_incremental_build

# Restore artifacts from the previous build (if they exist).
echo "---> Restoring build artifacts..."
if [ "$(ls -A /tmp/artifacts/ 2>/dev/null)" ]; then
  echo "---> Restoring found build artifacts..."
  cp -Rf /tmp/artifacts/. ./
fi

echo "---> Installing application source..."
cp -Rf /tmp/src/. ./

echo "injected vars: commonVersion: $commonVersion buildVersion: $buildVersion infraVersion: $infraVersion"
export JAVA_TOOL_OPTIONS="$JAVA_TOOL_OPTIONS -DcommonVersion=$commonVersion -DbuildVersion=$buildVersion -DinfraVersion=$infraVersion"
echo "new JAVA_TOOL_OPTIONS: $JAVA_TOOL_OPTIONS"

# Start build using gradle.
if [ -f "$LOCAL_SOURCE_DIR/build.gradle" ]; then
 # pushd $LOCAL_SOURCE_DIR &> /dev/null

  echo "---> Building application from source..."
  GRADLE_ARGS=${GRADLE_ARGS:-"build"}
  echo "--> # GRADLE_ARGS = $GRADLE_ARGS"
  #if [ -f "gradlew" ]; then

    echo "---> Building application with gradle..."
    /usr/local/gradle/bin/gradle $GRADLE_ARGS

    ERR=$?
      if [ $ERR -ne 0 ]; then
        echo "Aborting due to error code $ERR from Gradle build"
        exit $ERR
      fi

  #else
  #  echo "---> Building application with installed gradle..."
  #  gradle $GRADLE_ARGS
  #
  #  ERR=$?
  #    if [ $ERR -ne 0 ]; then
  #      echo "Aborting due to error code $ERR from Gradle build"
  #      exit $ERR
  #    fi
  #fi

  # optionally clear the local maven repository after the build
  # clear_maven_repository

  # popd &> /dev/null
fi

echo "My $(pwd) file system: $(ls -la)"
cd $(dirname $0)
echo "My $(dirname $0) file system: $(ls -la)"

cd /home/jboss
echo "My $(pwd) file system: $(ls -la)"

cd /home/jboss/web
echo "My $(pwd) file system: $(ls -la)"

cd /tmp
echo "My $(pwd) file system: $(ls -la)"

cd /tmp/artifacts
echo "My $(pwd) file system: $(ls -la)"

# Copy to webapps dir
ARTIFACT_DIR=/home/jboss/web/build/libs
echo "--> # ARTIFACT_DIR = $ARTIFACT_DIR"
echo "---> Rename artifact $(find $ARTIFACT_DIR -name *.war)"
result_file=$(find $ARTIFACT_DIR -name *.war)
if [ -z "$result_file" ]; then
   echo "---> Build file $result_file could not be found"
   exit 1
fi

mv $result_file $DEPLOY_DIR/ROOT.war
