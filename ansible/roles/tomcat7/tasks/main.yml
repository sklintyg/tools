---

- name: Add tomcat group "{{ tomcat_group }}"
  group: "name={{ tomcat_user }}"

- name: Add tomcat user "{{ tomcat_user }}"
  user: "name={{ tomcat_user }} group={{ tomcat_group }} createhome=no"

- name: Download tomcat
  get_url: url={{ tomcat_download_url }}
           dest={{ archive_dir }}/apache-tomcat-{{ tomcat7_version }}.tar.gz

- name: Make tomcat install dir
  file: "state=directory path={{ tomcat7_install_dir}}"

- name: Extract tomcat
  unarchive:
    src: "{{ archive_dir }}/apache-tomcat-{{ tomcat7_version }}.tar.gz"
    dest: "{{ tomcat7_install_dir}}"
    extra_opts: ['--strip-components=1', '--show-stored-names']
    remote_src: yes
    creates: "{{ tomcat7_install_dir}}/bin/startup.sh"

- name: Remove tomcat home symlink, if exists
  file: "state=absent path={{ tomcat7_home }}"

- name: Create symlink to tomcat home
  file: state=link src={{ tomcat7_install_dir}} path={{ tomcat7_home }} mode=755

- name: Change ownership of Tomcat installation
  file: path={{ tomcat7_install_dir}} owner=inera-tomcat group=inera-tomcat state=directory recurse=yes

###########

- name: Create log dir
  command: mv {{ tomcat7_home }}/logs /var/log/{{ tomcat_service }}
  args:
    creates: "/var/log/{{ tomcat_service }}/"

- name: Create tomcat directory in lib
  file: path=/var/lib/{{ tomcat_service }} state=directory mode=0755

- name: Create var directories
  command: "mv {{ tomcat7_home }}/{{ item }} /var/lib/{{ tomcat_service }}/{{ item }}"
  args:
    creates: "/var/lib/{{ tomcat_service }}/{{ item }}"
  with_items:
    - conf
    - webapps

- name: Remove installed wars
  file: state=absent
        path=/var/lib/{{ tomcat_service }}/webapps/{{ item }}
  with_items:
    - examples

- name: Remove installed dirs
  file: state=absent
        path={{ tomcat7_home }}/{{ item }}
  with_items:
    - conf
    - webapps
    - logs

- name: Redirect log dir
  file: state=link
        src=/var/log/{{ tomcat_service }}
        dest={{ tomcat7_home }}/logs

- name: Create tomcat internal links
  file: state=link
        src=/var/lib/{{ tomcat_service }}/{{ item }}
        dest={{ tomcat7_home }}/{{ item }}
  with_items:
    - conf
    - webapps

- name: Set rights on dirs
  file: owner={{ tomcat_user }} group={{ tomcat_user }} path={{ item }} state=directory recurse=yes
  with_items:
    - /var/log/{{ tomcat_service }}
    - /var/lib/{{ tomcat_service }}

- name: Add init.d script
  template: src=tomcat-init.sh.j2 dest=/etc/init.d/{{ tomcat_service }} mode=755

- name: Add tomcat-user.xml
  template: src=tomcat-users.xml.j2 dest={{ tomcat7_home }}/conf/tomcat-users.xml owner={{ tomcat_user }} mode=644

- name: Add server.xml
  template: src=server.xml.j2 dest={{ tomcat7_home }}/conf/server.xml owner={{ tomcat_user }} mode=644

- name: Enable Tomcat
  service: name={{ tomcat_service }} state=stopped enabled=yes
